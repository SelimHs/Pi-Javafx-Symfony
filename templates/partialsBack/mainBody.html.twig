<div class="app-main__outer">
    <div class="app-main__inner">
        <!-- Header avec titre et actions -->
        <div class="app-page-title">
            <div class="page-title-wrapper">
                <div class="page-title-heading">
                    <div class="page-title-icon">
                        <i class="pe-7s-graph1 icon-gradient bg-mean-fruit"></i>
                    </div>
                    <div>Tableau de Bord Administratif
                        <div class="page-title-subheading">Analyse complète des performances et des statistiques</div>
                    </div>
                </div>
                <div class="page-title-actions">
                    <button type="button" class="btn-shadow mr-3 btn btn-dark" data-toggle="tooltip" 
                            data-placement="bottom" title="Exporter les données">
                        <i class="fa fa-file-export"></i>
                    </button>
                    <div class="d-inline-block dropdown">
                        <button type="button" class="btn btn-primary btn-shadow dropdown-toggle" 
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="btn-icon-wrapper pr-2 opacity-7">
                                <i class="fas fa-cog"></i>
                            </span>
                            Actions
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#"><i class="fas fa-sync-alt mr-2"></i>Actualiser</a>
                            <a class="dropdown-item" href="#"><i class="fas fa-filter mr-2"></i>Filtrer</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#"><i class="fas fa-download mr-2"></i>Télécharger PDF</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cartes de statistiques principales -->
        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card mb-3 widget-content bg-premium-dark">
                    <div class="widget-content-wrapper text-white">
                        <div class="widget-content-left">
                            <div class="widget-heading">Utilisateurs Totaux</div>
                            <div class="widget-subheading">Inscriptions ce mois</div>
                        </div>
                        <div class="widget-content-right">
                            <div class="widget-numbers text-white"><span>{{ total_users }}</span></div>
                            <div class="widget-description"><i class="fa fa-arrow-up mr-1"></i>12%</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card mb-3 widget-content bg-arielle-smile">
                    <div class="widget-content-wrapper text-white">
                        <div class="widget-content-left">
                            <div class="widget-heading">Événements Actifs</div>
                            <div class="widget-subheading">Événements à venir</div>
                        </div>
                        <div class="widget-content-right">
                            <div class="widget-numbers text-white"><span>{{ active_events }}</span></div>
                            <div class="widget-description"><i class="fa fa-calendar mr-1"></i>+3 nouveaux</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card mb-3 widget-content bg-grow-early">
                    <div class="widget-content-wrapper text-white">
                        <div class="widget-content-left">
                            <div class="widget-heading">Billets Vendus</div>
                            <div class="widget-subheading">30 derniers jours</div>
                        </div>
                        <div class="widget-content-right">
                            <div class="widget-numbers text-white"><span>{{ tickets_sold }}</span></div>
                            <div class="widget-description"><i class="fa fa-ticket-alt mr-1"></i>+24%</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card mb-3 widget-content bg-night-fade">
                    <div class="widget-content-wrapper">
                        <div class="widget-content-left">
                            <div class="widget-heading">Revenus</div>
                            <div class="widget-subheading">Chiffre d'affaires</div>
                        </div>
                        <div class="widget-content-right">
                            <div class="widget-numbers text-primary"><span>{{ revenue|number_format(0, ',', ' ') }} €</span></div>
                            <div class="widget-description text-success"><i class="fa fa-chart-line mr-1"></i>18%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section principale avec graphiques -->
        <div class="row">
            <!-- Graphique des ventes -->
            <div class="col-md-12 col-lg-8">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        <div class="card-header-title font-size-lg text-capitalize font-weight-normal">
                            Performance des Ventes
                        </div>
                        <div class="btn-actions-pane-right">
                            <div role="group" class="btn-group-sm btn-group">
                                <button class="active btn btn-focus">Mensuel</button>
                                <button class="btn btn-focus">Trimestriel</button>
                                <button class="btn btn-focus">Annuel</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="sales-performance-chart" height="300"></canvas>
                    </div>
                    <div class="card-footer">
                        <div class="text-muted">
                            <small>Dernière mise à jour: {{ "now"|date("d/m/Y H:i") }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques utilisateurs -->
            <div class="col-md-12 col-lg-4">
                <div class="mb-3 card">
                    <div class="card-header">
                        <div class="card-title">Statistiques Utilisateurs</div>
                    </div>
                    <div class="card-body">
                        <div class="dashboard-donut-chart">
                            <canvas id="user-stats-chart" height="200"></canvas>
                        </div>
                        <div class="mt-4">
                            <div class="mb-3 progress">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" 
                                     aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">Nouveaux: 65%</div>
                            </div>
                            <div class="mb-3 progress">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 35%;" 
                                     aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">Actifs: 35%</div>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" 
                                     aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Inactifs: 25%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section secondaire avec graphiques et formulaire -->
        <div class="row">
            <!-- Répartition Hommes/Femmes -->
            <div class="col-md-12 col-lg-6">
                <div class="main-card mb-3 card">
                    <div class="card-header">Démographie des Utilisateurs</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="gender-chart" height="250"></canvas>
                            </div>
                            <div class="col-md-6">
                                <div class="widget-chart widget-chart2 text-left pt-3 pb-2">
                                    <div class="widget-chat-wrapper-outer">
                                        <div class="widget-chart-content">
                                            <div class="widget-numbers text-success">64%</div>
                                            <div class="widget-subheading">Taux d'engagement</div>
                                        </div>
                                        <div class="widget-chart-wrapper">
                                            <canvas id="engagement-chart" height="100"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="pt-3">
                                    <div class="text-muted opacity-6">Répartition par âge</div>
                                    <canvas id="age-distribution-chart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire d'invitation admin -->
            <div class="col-md-12 col-lg-6">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        <div>Gestion des Administrateurs</div>
                        <div class="btn-actions-pane-right">
                            <div role="group" class="btn-group-sm btn-group">
                                <a href="{{ path('admin_user_pending') }}" class="btn btn-primary active">
                                    <i class="fas fa-user-clock mr-1"></i>En attente
                                </a>
                                <button class="btn btn-primary">
                                    <i class="fas fa-users mr-1"></i>Liste
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
                            <form method="post" action="{{ path('send_invitation_admin') }}" class="needs-validation" novalidate>
                                <div class="form-group">
                                    <label for="email">Inviter un nouvel administrateur</label>
                                    <div class="input-group">
                                        <input type="email" class="form-control" name="email" id="email" 
                                               placeholder="Email de l'invité" required>
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-paper-plane mr-1"></i>Envoyer
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">
                                            Veuillez fournir une adresse email valide
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        Un lien d'activation sera envoyé à cette adresse email
                                    </small>
                                </div>
                            </form>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Accès réservé aux administrateurs
                            </div>
                        {% endif %}

                        {% for message in app.flashes('success') %}
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle mr-2"></i>{{ message }}
                            </div>
                        {% endfor %}
                        {% for message in app.flashes('error') %}
                            <div class="alert alert-danger mt-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>{{ message }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des utilisateurs récents -->
        <div class="row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        <div>Activité Récente des Utilisateurs</div>
                        <div class="btn-actions-pane-right">
                            <div class="nav">
                                <a href="javascript:void(0);" class="border-0 btn-pill btn-wide btn-transition active btn btn-outline-alternate">Tous</a>
                                <a href="javascript:void(0);" class="btn-pill btn-wide border-0 btn-transition btn btn-outline-alternate">Actifs</a>
                                <a href="javascript:void(0);" class="btn-pill btn-wide border-0 btn-transition btn btn-outline-alternate">Nouveaux</a>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="align-middle mb-0 table table-borderless table-striped table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Utilisateur</th>
                                    <th class="text-center">Inscription</th>
                                    <th class="text-center">Activité</th>
                                    <th class="text-center">Statut</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in recent_users %}
                                <tr>
                                    <td class="text-center">{{ user.id }}</td>
                                    <td>
                                        <div class="widget-content p-0">
                                            <div class="widget-content-wrapper">
                                                <div class="widget-content-left mr-3">
                                                    <img width="40" class="rounded-circle" 
                                                         src="{{ user.avatar|default('assets/images/avatars/default.jpg') }}" 
                                                         alt="{{ user.fullName }}">
                                                </div>
                                                <div class="widget-content-left flex2">
                                                    <div class="widget-heading">{{ user.fullName }}</div>
                                                    <div class="widget-subheading opacity-7">{{ user.email }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {{ user.createdAt|date('d/m/Y') }}
                                    </td>
                                    <td class="text-center">
                                        {{ user.lastLogin|date('H:i d/m/Y') }}
                                    </td>
                                    <td class="text-center">
                                        {% if user.isActive %}
                                            <div class="badge badge-success">Actif</div>
                                        {% else %}
                                            <div class="badge badge-warning">Inactif</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-primary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-block text-center card-footer">
                        <button class="btn-wide btn btn-primary">Voir plus</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    // Graphique de performance des ventes
    const salesCtx = document.getElementById('sales-performance-chart').getContext('2d');
    const salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
            datasets: [{
                label: 'Billets vendus',
                data: [120, 190, 170, 220, 300, 280, 350, 400, 380, 450, 500, 600],
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }, {
                label: 'Revenus (k€)',
                data: [2.4, 3.8, 3.4, 4.4, 6.0, 5.6, 7.0, 8.0, 7.6, 9.0, 10.0, 12.0],
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    usePointStyle: true,
                },
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Billets vendus'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                    title: {
                        display: true,
                        text: 'Revenus (k€)'
                    }
                }
            }
        }
    });

    // Graphique des statistiques utilisateurs
    const userStatsCtx = document.getElementById('user-stats-chart').getContext('2d');
    const userStatsChart = new Chart(userStatsCtx, {
        type: 'doughnut',
        data: {
            labels: ['Nouveaux', 'Actifs', 'Inactifs'],
            datasets: [{
                data: [65, 35, 25],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(255, 193, 7, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    cornerRadius: 8
                }
            }
        }
    });

    // Graphique de répartition hommes/femmes
    const genderCtx = document.getElementById('gender-chart').getContext('2d');
    const genderChart = new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: ['Hommes', 'Femmes', 'Autres'],
            datasets: [{
                data: [{{ hommes|default(60) }}, {{ femmes|default(35) }}, 5],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.raw + '%';
                            return label;
                        }
                    }
                },
                datalabels: {
                    formatter: (value) => {
                        return value + '%';
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Graphique d'engagement
    const engagementCtx = document.getElementById('engagement-chart').getContext('2d');
    const engagementChart = new Chart(engagementCtx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [{
                data: [45, 60, 55, 70, 65, 80, 75],
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2,
                tension: 0.4,
                pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                pointRadius: 4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    display: false
                },
                x: {
                    display: false
                }
            }
        }
    });

    // Graphique de répartition par âge
    const ageCtx = document.getElementById('age-distribution-chart').getContext('2d');
    const ageChart = new Chart(ageCtx, {
        type: 'bar',
        data: {
            labels: ['<18', '18-24', '25-34', '35-44', '45-54', '55+'],
            datasets: [{
                data: [5, 25, 35, 20, 10, 5],
                backgroundColor: 'rgba(108, 117, 125, 0.6)',
                borderColor: 'rgba(108, 117, 125, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    display: false
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Validation du formulaire
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>