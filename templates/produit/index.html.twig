{% extends 'base.html.twig' %}

{% block title %}Nos Produits{% endblock %}

{% block body %}
<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <span class="breadcrumb"><a href="{{ path('app_home') }}">Accueil</a> / Produits</span>
        <h3>Nos Produits</h3>
      </div>
    </div>
  </div>
</div>

<div class="section properties">
  <div class="container">
    <div class="text-center mb-4">
      <button class="btn btn-warning" id="btnGenerateIdea">üí° G√©n√©rer une id√©e d‚Äô√©v√©nement</button>
    </div>

    {% if produits is empty %}
      <div class="alert alert-info text-center">Aucun produit trouv√©.</div>
    {% else %}
      <div class="row properties-box">
        {% for produit in produits %}
          <div class="col-lg-4 col-md-6 align-self-center mb-30 properties-items espace-card">
            <div class="item position-relative shadow-sm">

              <div class="form-check position-absolute" style="top: 10px; left: 10px;">
                <input type="checkbox" class="form-check-input produit-select" value="{{ produit.idProduit }}">
              </div>

              {% if produit.imagePath %}
                <img src="{{ asset('uploads/' ~ produit.imagePath) }}" class="card-img-top" alt="{{ produit.nomProduit }}">
              {% else %}
                <img src="{{ asset('uploads/placeholder.png') }}" class="card-img-top" alt="Pas d'image">
              {% endif %}
              <span class="category">{{ produit.categorie }}</span>
              <h6>{{ produit.prixProduit }} Dt</h6>
              <h4><a href="{{ path('app_produit_show', {'idProduit': produit.idProduit}) }}">{{ produit.nomProduit }}</a></h4>
              <ul>
                <li>Quantit√© : <span>{{ produit.quantite }}</span></li>
              </ul>
              <div class="main-button d-flex justify-content-center mt-2">
                <a href="{{ path('app_produit_show', {'idProduit': produit.idProduit}) }}" class="btn btn-outline-dark">üîç D√©tails</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Popup IA -->
<div class="modal fade" id="ideaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Id√©e d'√âv√©nement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ideaContent">Chargement...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascripts %}
{{ parent() }}
<script>
document.getElementById('btnGenerateIdea')?.addEventListener('click', async () => {
  const ids = [...document.querySelectorAll('.produit-select:checked')].map(cb => cb.value);
  if (ids.length === 0) {
    alert("‚ùó Veuillez s√©lectionner au moins un produit.");
    return;
  }

  const modalElement = document.getElementById('ideaModal');
  const ideaModal = bootstrap.Modal.getOrCreateInstance(modalElement);
  document.getElementById('ideaContent').innerText = "‚è≥ Id√©e en cours de g√©n√©ration...";
  ideaModal.show();

  try {
    const res = await fetch("{{ path('produit_generate_event_idea') }}?ids=" + ids.join(','));

    // üõ°Ô∏è NE PAS faire .json() tout de suite !
    const contentType = res.headers.get("Content-Type");
    const text = await res.text();

    if (contentType && contentType.includes("application/json")) {
      const data = JSON.parse(text);
      document.getElementById('ideaContent').innerText = data.idea ?? "‚ùå R√©ponse vide.";
    } else {
      // üõë Ce n'est pas du JSON ‚Üí affiche brut (erreur HTML, Twig, etc.)
      document.getElementById('ideaContent').innerText = "‚ùå Erreur : r√©ponse non JSON\n\n" + text;
    }

  } catch (err) {
    document.getElementById('ideaContent').innerText = "‚ùå Exception JS : " + err.message;
    console.error(err);
  }
});

</script>
{% endblock %}
