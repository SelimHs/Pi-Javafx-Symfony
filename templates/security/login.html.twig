{% extends 'base.html.twig' %}

{% block title %}Login | Lamma Event{% endblock %}

{% block body %}
<div class="container d-flex flex-column align-items-center justify-content-center min-vh-100">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-primary">LAMMA EVENT</h1>
        <p class="text-muted small">Manage your events easily and quickly</p>
    </div>

    <div class="card p-5 shadow rounded-4 w-100" style="max-width: 420px;">
        <form method="post" class="dark-mode-form">

            {% if error %}
                <div class="alert alert-danger small text-center mb-4">
                    {{ error.messageKey|trans(error.messageData, 'security') }}
                </div>
            {% endif %}

            {% if app.user %}
                <div class="alert alert-success text-center mb-4">
                    Logged in as <strong>{{ app.user.userIdentifier }}</strong>.
                    <a href="{{ path('app_logout') }}" class="btn btn-outline-danger btn-sm ms-2">Logout</a>
                </div>
            {% endif %}

            <h2 class="h5 text-center mb-4 fw-semibold">Welcome Back ğŸ‘‹</h2>

            <div class="form-floating mb-3">
                <input type="email" id="inputEmail" name="email" value="{{ last_username }}" class="form-control" placeholder="Email" autocomplete="email" required autofocus>
                <label for="inputEmail">Email Address</label>
            </div>

            <div class="form-floating mb-3 position-relative">
                <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Password" autocomplete="current-password" required>
                <label for="inputPassword">Password</label>
                <button type="button" id="togglePassword" class="btn position-absolute end-0 top-50 translate-middle-y me-3 p-0 border-0" style="width: 35px; height: 35px; background: none;">
                    ğŸ‘ï¸
                </button>
            </div>

            <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="rememberMe" name="_remember_me">
                <label class="form-check-label small" for="rememberMe">Remember me</label>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-3 fw-bold">
                ğŸ”’ Sign In
            </button>
        </form>

        <!-- ğŸš€ Login avec visage sÃ©parÃ© du formulaire -->
       <button id="openFaceLogin" class="btn w-100 mb-3 fw-bold text-white"
        style="background: linear-gradient(135deg, #f35525 0%, #ff6b3d 100%);">
    ğŸ“¸ Login with your face
</button>


        <div id="faceModal" class="text-center" style="display:none;">
            <video id="video" autoplay style="width:100%; max-width:300px; border-radius: 10px;"></video>
            <br>
            <button id="captureBtn" class="btn btn-danger mt-2">ğŸ“· Capturer</button>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');

        document.getElementById('openFaceLogin').addEventListener('click', (e) => {
            e.preventDefault(); // Ã©vite rechargement
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
                document.getElementById('faceModal').style.display = 'block';
            }).catch(err => {
                alert("Erreur d'accÃ¨s camÃ©ra : " + err.message);
            });
        });

        captureBtn.addEventListener('click', (event) => {
            event.preventDefault();

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob, 'face.jpg');

             fetch('/face-auth', {
    method: 'POST',
    body: formData
})
.then(res => res.json())
.then(data => {
    if (data.success) {
        window.location.href = data.redirect; // ğŸ” redirection dynamique
    } else {
        alert('âŒ ' + data.message);
    }
});

            });
        });
        </script>

        <div class="text-center mb-3">
            <span class="small text-muted">or</span>
        </div>

     <!-- ğŸ”´ Login with Google (red button + logo) -->
<a href="{{ path('connect_google') }}"
   class="btn w-100 mb-3 fw-bold text-white d-flex align-items-center justify-content-center"
   style="height: 45px; background-color: #DB4437; gap: 10px;">
    <i class="fab fa-google"></i>
    <span>Sign In with Google</span>
</a>


        <div class="text-center mb-2">
            <a href="{{ path('app_forgot_password') }}" class="small text-decoration-none text-primary">Forgot Password?</a>
        </div>

        <div class="text-center small">
            Don't have an account? 
            <a href="{{ path('app_register') }}" class="fw-bold text-decoration-none text-primary">Sign Up</a>
        </div>
    </div>
</div>

<!-- ğŸ¨ Style -->
<style>
body.dark-mode .dark-mode-form {
    background-color: #2d2d3f;
    color: #e0e0e0;
}
body.dark-mode .dark-mode-form input,
body.dark-mode .dark-mode-form label {
    background-color: #393953;
    color: #e0e0e0;
    border: 1px solid #555;
}
#togglePassword {
    font-size: 1.3rem;
    cursor: pointer;
    transition: transform 0.2s ease, color 0.2s ease;
}
#togglePassword:hover {
    color: #f35525;
    transform: scale(1.2);
}
</style>

<!-- ğŸ‘ï¸ Toggle password -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('inputPassword');

    togglePassword.addEventListener('click', () => {
        const isPassword = passwordInput.getAttribute('type') === 'password';
        passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
        togglePassword.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
    });
});
</script>
{% endblock %}
