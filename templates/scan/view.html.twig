{% extends 'base.html.twig' %}

{% block title %}Détails de l'Événement{% endblock %}

{% block body %}
<div class="container mt-5 text-center">
  <h1>🎉 Détails de l'Événement 🎉</h1>
  <div class="event-container p-4 bg-light rounded shadow">
    <p><strong>🎭 Nom de l'événement:</strong> <span id="eventName">Chargement...</span></p>
    <p><strong>👤 Propriétaire:</strong> <span id="owner">Chargement...</span></p>
    <p><strong>📍 Adresse:</strong> <span id="location">Chargement...</span></p>
    <p><strong>📅 Date:</strong> <span id="date">Chargement...</span></p>
    <p><strong>🎟️ Type de billet:</strong> <span id="ticketType">Chargement...</span></p>
    <p><strong>💰 Prix:</strong> <span id="price">Chargement...</span></p>
    <p id="countdown" class="mt-3 fs-4 text-danger"></p>
  </div>
</div>

<script>
fetch("{{ path('scan_data_json') }}?t=" + new Date().getTime())
  .then(res => res.json())
  .then(data => {
    document.getElementById("eventName").innerText = data["Nom event"] || "N/A";
    document.getElementById("owner").innerText = data["Proprietaire"] || "N/A";
    document.getElementById("location").innerText = data["Adresse"] || "N/A";
    document.getElementById("date").innerText = data["Date"] || "N/A";
    document.getElementById("ticketType").innerText = data["Type billet"] || "N/A";
    document.getElementById("price").innerText = (data["Prix"] ?? "N/A") + " DT";

    startCountdown(data["Date"]);
  })
  .catch(err => {
    console.error("Erreur de chargement des données:", err);
    document.getElementById("countdown").innerText = "⚠️ Impossible de charger les données.";
  });

function startCountdown(dateString) {
  let target = new Date(dateString).getTime();

  if (isNaN(target)) {
    document.getElementById("countdown").innerText = "⚠️ Date invalide";
    return;
  }

  setInterval(() => {
    const now = new Date().getTime();
    const distance = target - now;

    if (distance <= 0) {
      document.getElementById("countdown").innerText = "🚀 L'événement a commencé !";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    document.getElementById("countdown").innerText =
      `⏳ Temps restant: ${days}j ${hours}h ${minutes}m ${seconds}s`;
  }, 1000);
}
</script>
{% endblock %}
